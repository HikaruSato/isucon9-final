# ベンチマーカー

## ビルド

```
$ make
```


## テスト

```
$ make test
```


## シナリオ作成の流れ

* `scenario/template.go` をコピーする。
    * ファイルをコピーしないでください
    * あくまで、関数をテキストコピーし、適切なファイル(正常テストならnormal.go)に配置してください
* `AwesomeScenario()` 関数の名前を変える
    * シナリオは `normal(正常)` `abnormal(異常)` `attack(攻撃)` などのシナリオ種別があります
    * `func <シナリオ種別><何をするか>Scenario` のように関数名を変更してください
* シナリオの中身をかく
* シナリオのテストを書く
* cmd/bench/benchmarker.go で定義されている load(ctx context.Context) にシナリオ実行する実装をする
* プルリクエストをだす

## シナリオ作成における注意事項

* 負荷レベルをあげたい
    * デフォルトでは、ベンチマーカーが１ワークロード（シナリオ複数含む）が終わるごとレベルアップし、レベル数分だけgoroutineを生成します
    * そのほかに、シナリオ内で負荷をあげる選択肢もあり、これには scenario/attack.go のコードなどを参考にしてください

* isutrainやpaymentにリクエストを送りたい
    * isutrain.Client, payment.Clientを用います (NewClient()でClientを生成できます)
    * Clientが提供する関数を用いると、HTTPリクエスト失敗やJSON Unmarshal失敗などのエラーを検知し、そのエラーを返してくれます. シナリオ側で、これをbencherrorに追加する必要があります
    * レスポンスの具体的な中身についてチェックをし、エラーとしたい場合はscenario/assertion.goで提供される関数群を用いて、 bencherrorに適宜エラーを追加してください

* ランダムデータが欲しい
    * xrandom.GetXXX を用いてください
    * なければ定義するようにお願いします
        * DBからそのまま引っこ抜いてきたようなランダムデータはxrandomパッケージ内で閉じて定義されていますが、それ以外のパラメータはconfigパッケージに集められています

* エラーを追加したい
    * bencherrorパッケージを用います
    * エラーを追加することは、「ユーザにそのエラーメッセージを見せる」、「ペナルティとして計上する」ことを意味します
    * エラーは全部で４種類ありますが、シナリオで用いるエラーは２種類しかありません
        * アプリケーションエラー ... webappの挙動が正しくない場合やサービスとして安定していない場合のエラー. 重みと掛け合わせてペナルティ算出されます
        * クリティカルエラー ... このエラーが発生したと判断された場合、即失格となります. ベンチマークは止まりますし、スコアは０になります
    * 書き方は以下のようなものがあります
        * エラーを得て、それにメッセージを付加してbencherrorに追加したい
            * bencherror.BenchmarkErrs.AddError(bencherror.NewApplicationError(err, "メッセージ: %d", 123))
        * エラーがないが、メッセージのみでbencherrorに追加したい
            * bencherror.BenchmarkErrs.AddError(bencherror.NewSimpleApplicationError("メッセージ: %d", 123))

* ユーザには見せないが、ポータルから確認できるメッセージを書き込みたい
    * 標準出力に不用意に文字列を書き込んでしまうと、ベンチマーク結果のUnmarshalに失敗し、大事故になります
    * デバッグメッセージなどは `必ず` 標準エラー出力に出すようにしてください
    * 方法は２つ用意されています
        * lgr := zap.S() で得られる zap.SugaredLoggerを用いる方法
        * 標準 logパッケージのPrintXを用いる方法
    * 可能であれば、zapのを用いてください. いくつかlog.Printしている箇所がありますが、これは意図的でなく、のちほど修正予定のものです

* 予約状況に応じて、座席を選択したい
    * すみません、未実装です
    * internal/cache パッケージ内にて実装中で、これを用いて今予約しようとしている座席が予約可能かどうか判定できるようにしようと考えています
    * 予約できるなら 正常HTTPステータスコードが返るはずだし、そうでないなら異常HTTPステータスコードが返るはずという具合です